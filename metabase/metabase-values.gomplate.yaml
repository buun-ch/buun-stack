# Metabase Helm Chart Values
# https://github.com/pmint93/helm-charts/tree/master/charts/metabase

image:
  repository: metabase/metabase
  tag: v0.51.1

# Use PostgreSQL for production
database:
  type: postgres
  host: postgres-cluster-rw.postgres
  port: 5432
  dbname: metabase
  existingSecret: database-config
  existingSecretUsernameKey: user
  existingSecretPasswordKey: password

ingress:
  enabled: true
  className: traefik
  annotations:
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  hosts:
    - {{ .Env.METABASE_HOST }}
  tls:
    - hosts:
        - {{ .Env.METABASE_HOST }}

# Session configuration
session:
  existingSecret: metabase-config
  existingSecretKey: session

# Trino driver plugin configuration
extraInitContainers:
  - name: download-trino-driver
    image: curlimages/curl:8.5.0
    imagePullPolicy: IfNotPresent
    volumeMounts:
      - name: plugins
        mountPath: /plugins
    workingDir: /plugins
    command:
      - /bin/sh
      - -ec
      - |
        curl -Lso /plugins/starburst.metabase-driver.jar \
          https://github.com/starburstdata/metabase-driver/releases/download/6.1.0/starburst-6.1.0.metabase-driver.jar
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      runAsNonRoot: true
      runAsUser: 100
      runAsGroup: 101
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
          - ALL

extraVolumeMounts:
  - name: plugins
    mountPath: /plugins
    readOnly: false

extraVolumes:
  - name: plugins
    emptyDir: {}

# Basic configuration
extraEnv:
  - name: MB_APPLICATION_NAME
    value: "Metabase Analytics"
  - name: MB_ENABLE_PUBLIC_SHARING
    value: "true"
  - name: MB_ENABLE_EMBEDDING
    value: "true"

resources:
  requests:
    cpu: 25m
    memory: 3Gi
  limits:
    cpu: 500m
    memory: 8Gi

# Security context for Pod Security Standards (restricted)
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 2000
  runAsGroup: 2000
  fsGroup: 2000
  fsGroupChangePolicy: OnRootMismatch
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 2000
  runAsGroup: 2000
  seccompProfile:
    type: RuntimeDefault
  capabilities:
    drop:
      - ALL

# Service account
serviceAccount:
  create: true

# Log4j2 configuration to reduce verbose logging
log4j2XML: |
  <?xml version="1.0" encoding="UTF-8"?>
  <Configuration status="WARN" shutdownHook="disable">
    <Appenders>
      <Console name="STDOUT" target="SYSTEM_OUT">
        <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %c{1.} :: %m%n"/>
      </Console>
    </Appenders>
    <Loggers>
      <Logger name="metabase.middleware.log" level="WARN"/>
      <Logger name="middleware.log" level="WARN"/>
      <Logger name="metabase" level="WARN"/>
      <Root level="WARN">
        <AppenderRef ref="STDOUT"/>
      </Root>
    </Loggers>
  </Configuration>
